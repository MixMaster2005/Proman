<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Projets</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#f72585',
                        dark: '#181824',
                        'dark-blue': '#232946',
                    }
                }
            }
        }
    </script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #181824 0%, #232946 100%);
            min-height: 100vh;
            color: #f4f4f8;
        }

        .modal.fade.show {
            display: block;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        /* Ajustement des styles pour les modales de Bootstrap */
        .modal-content {
            background-color: #232946 !important;
            border-color: #393e60 !important;
        }

        .btn-close {
            color: white !important;
            filter: invert(1) grayscale(100%) brightness(200%);
        }

        /* Style des inputs pour correspondre au thème sombre */
        .form-control {
            background-color: #181824 !important;
            border-color: #393e60 !important;
            color: #f4f4f8 !important;
        }

        .form-control:focus {
            background-color: #232946 !important;
            border-color: #3b82f6 !important;
            box-shadow: 0 0 0 0.25rem rgba(59, 130, 246, 0.25) !important;
        }
    </style>
</head>

<body class="min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <nav class="bg-dark-blue/90 backdrop-blur-md border-b border
                    border-gray-700 rounded-2xl p-4 mb-8 shadow-lg">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <h1 class="text-2xl font-bold bg-gradient-to-r from-primary to-secondary 
                             bg-clip-text text-transparent">
                        ProMan
                    </h1>
                    <span class="text-gray-400">|</span>
                    <span class="text-gray-300">Bienvenue, Chef de Projet</span>
                </div>
                <button id="addProjectBtn" 
                        class="btn-primary flex items-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M12 4v16m8-8H4">
                        </path>
                    </svg>
                    <span>Nouveau projet</span>
                </button>
            </div>
        </nav>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="projectsContainer">
            <!-- Les projets seront ajoutés ici dynamiquement -->
        </div>
    </div>

    <!-- Modal Nouveau Projet -->
    <div class="modal fade" id="addProjectModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark-blue border border-gray-700 rounded-xl shadow-2xl">
                <div class="modal-header border-b border-gray-700 p-4">
                    <h5 class="modal-title text-xl font-semibold">Créer un nouveau projet</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-6">
                    <form id="addProjectForm">
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Nom du projet</label>
                            <input type="text" class="w-full px-4 py-2 bg-dark border border-gray-700 
                                                    rounded-lg focus:ring-2 focus:ring-primary"
                                   id="projectName" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Date de début</label>
                            <input type="date" class="w-full px-4 py-2 bg-dark border border-gray-700 
                                                    rounded-lg focus:ring-2 focus:ring-primary"
                                   id="startDate" required>
                        </div>
                        <button type="submit" class="btn-primary w-full">Créer</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Collaborateurs -->
    <div class="modal fade" id="addCollaboratorsModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark-blue border border-gray-700 rounded-xl shadow-2xl">
                <div class="modal-header border-b border-gray-700 p-4">
                    <h5 class="modal-title text-xl font-semibold">Ajouter des collaborateurs</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-6">
                    <form id="addCollaboratorsForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Email du collaborateur</label>
                            <input type="email" class="w-full px-4 py-2 bg-dark border border-gray-700 
                                                     rounded-lg focus:ring-2 focus:ring-primary"
                                   id="collaboratorEmail" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">ID du collaborateur</label>
                            <input type="number" class="w-full px-4 py-2 bg-dark border border-gray-700 
                                                      rounded-lg" 
                                   id="collaboratorId" readonly>
                        </div>
                        <div class="flex space-x-4">
                            <button type="button" id="findCollaboratorBtn" 
                                    class="px-4 py-2 bg-gray-700 text-white rounded-lg 
                                           hover:bg-gray-600 transition-colors">
                                Rechercher
                            </button>
                            <button type="submit" class="btn-primary flex-1">
                                Ajouter
                            </button>
                        </div>
                    </form>
                    <div class="mt-6">
                        <h6 class="text-sm font-medium mb-3">Collaborateurs ajoutés :</h6>
                        <ul id="collaboratorsUl" class="divide-y divide-gray-700"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function () {
            const token = localStorage.getItem('token');
            const id_contributeur = localStorage.getItem('id_contributeur');
            let currentProjectId = null;

            function loadProjects() {
                $.ajax({
                    url: `/api/projets/contributeur/${id_contributeur}`,
                    method: 'GET',
                    headers: { 'Authorization': 'Bearer ' + token },
                    success: function (projects) {
                        $('#projectsContainer').empty();
                        projects.forEach(project => {
                            $('#projectsContainer').append(`                                <div class="p-4">
                                    <div class="project-card bg-dark-blue border border-gray-700 rounded-xl p-6 
                                                transition-all duration-300 hover:scale-105 hover:border-primary 
                                                hover:shadow-xl cursor-pointer" data-id="${project.id_projet}">
                                        <div class="flex items-start justify-between mb-4">
                                            <div class="flex-1">
                                                <h3 class="text-xl font-semibold text-white mb-2">${project.nom_projet}</h3>
                                                <div class="flex items-center space-x-2 text-gray-400 mb-3">
                                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                        <path d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z"/>
                                                    </svg>
                                                    <span>${project.date_debut}</span>
                                                </div>
                                                <div class="bg-gray-700 rounded-full h-2 mb-3">
                                                    <div class="bg-gradient-to-r from-primary to-secondary h-2 rounded-full" 
                                                         style="width: 60%"></div>
                                                </div>
                                            </div>
                                            <span class="px-3 py-1 bg-primary/10 text-primary rounded-full text-sm font-semibold">
                                                Actif
                                            </span>
                                        </div>                                        <div class="flex justify-end">
                                            <div class="inline-flex items-center space-x-2 
                                                    px-4 py-2 bg-gray-700 text-white rounded-lg 
                                                    hover:bg-gray-600 transition-colors">
                                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                    <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793z"/>
                                                    <path d="M11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
                                                </svg>
                                                <span>Ouvrir</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `);                        });

                        // Gestionnaire d'événements pour l'ouverture des projets
                        $('.project-card').click(function () {
                            const projectId = $(this).data('id');
                            window.location.href = `/page/chefDeProjetDashboard/projet?id_projet=${projectId}`;
                        });
                    },
                    error: () => alert('Erreur lors du chargement des projets.')
                });
            }

            $('#addProjectBtn').click(() => {
                $('#addProjectModal').modal('show');
            });

            $('#addProjectForm').submit(function (e) {
                e.preventDefault();
                const formData = {
                    nom_projet: $('#projectName').val(),
                    date_debut: $('#startDate').val()
                };

                $.ajax({
                    url: '/api/projets',
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token },
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function (response) {
                        currentProjectId = response.id_projet;
                        $('#addProjectModal').modal('hide');
                        $('#projectName').val('');
                        $('#startDate').val('');

                        $.ajax({
                            url: '/api/collaborer',
                            method: 'POST',
                            headers: { 'Authorization': 'Bearer ' + token },
                            contentType: 'application/json',
                            data: JSON.stringify({
                                id_projet: currentProjectId,
                                id_contributeur: id_contributeur
                            }),
                            success: function () {
                                $('#collaboratorsUl').html(`<li class="list-group-item">${id_contributeur}</li>`);
                                $('#addCollaboratorsModal').modal('show');
                                loadProjects();
                            },
                            error: () => alert("Erreur lors de l'ajout du créateur au projet.")
                        });
                    },
                    error: () => alert("Erreur lors de la création du projet.")
                });
            });

            $('#findCollaboratorBtn').click(function () {
                const email = $('#collaboratorEmail').val();
                if (!email) return alert('Veuillez saisir un email.');

                $.ajax({
                    url: `/api/contributeur/email/${email}`,
                    method: 'GET',
                    headers: { 'Authorization': 'Bearer ' + token },
                    success: function (data) {
                        $('#collaboratorId').val(data.id_contributeur);
                    },
                    error: () => alert('Collaborateur non trouvé.')
                });
            });

            $('#addCollaboratorsForm').submit(function (e) {
                e.preventDefault();
                const collaboratorId = $('#collaboratorId').val();
                if (!collaboratorId) return alert("Veuillez rechercher un collaborateur avant de l'ajouter.");

                $.ajax({
                    url: '/api/collaborer',
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token },
                    contentType: 'application/json',
                    data: JSON.stringify({
                        id_projet: currentProjectId,
                        id_contributeur: collaboratorId
                    }),
                    success: function () {
                        $('#collaboratorsUl').append(`<li class="list-group-item">${collaboratorId}</li>`);
                        $('#collaboratorEmail').val('');
                        $('#collaboratorId').val('');
                    },
                    error: () => alert("Erreur lors de l'ajout du collaborateur.")
                });
            });

            loadProjects();
        });
    </script>
</body>
</html>